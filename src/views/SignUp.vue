<template>
  <div class="page-wrapper">
    <div class="component-wrapper">
      <svg
        version="1.1"
        fill="#13293D "
        class="image-top"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        x="0px"
        y="0px"
        width="256px"
        height="156px"
        viewBox="0 0 256 250"
        enable-background="new 0 0 226 206"
        xml:space="preserve"
      >
        <g id="Calque_2"></g>
        <g id="Layer_1">
          <g>
            <path
              d="M143.699,194.408c-4.088-0.007-8.176,0.236-12.24,0.676c-6.503,0.704-13.085,0.068-19.584,1.166
			c-0.346,0.059-0.726,0.113-1.117,0.168c0.49,0.732,0.703,1.623,0.657,2.506c1.614,1.06,2.211,3.133,1.766,4.816
			c8.461-0.173,16.921,0.22,25.381,0.682c1.768,0.03,3.535,0.066,5.303,0.116c-1.387-1.509-1.553-4.126,0.058-5.616
			c0.367-0.341,1.165-1.603,1.396-1.543c0.039-0.237,0.142-0.276,0.324-0.065c-0.225-1.037-0.101-2.006,0.322-2.843
			C145.21,194.432,144.455,194.409,143.699,194.408z"
            />
            <path
              d="M233.1,131.852c-0.059,0.011-0.309,0.046-0.365,0.055c0.253,0.948,0.111,5.848,0.069,8.247
			c-5.034,1.907-4.931,4.989-5.851,8.202c-7.215,26.801-20.523,25.092-47.541,24.506c-12.66-0.68-22.957,0.424-29.363-7.765
			c-13.033-15.686-10.012-25.785-17.4-31.562c-2.203-1.707-5.041-1.732-7.407,0.477c-3.127,2.928-5.022,8.717-5.92,12.865
			c-5.182,19.789-20.548,27.258-42.858,27.018c-23.849-0.104-36.483,1.65-43.894-21.867c-2.304-7.226-1.553-9.846-6.912-11.863
			c-0.038-1.053-0.296-9.619-0.315-11.089c3.412-1.23,7.092-3.293,7.241-3.834c2.564-7.683,5.831-13.899,13.151-16.001
			c16.503-4.827,57.193-4.744,77.265,8.385c3.526,2.306,9.231,2.739,13.751-0.125c19.902-12.611,46.988-11.756,67.35-9.823
			c12.419,1.142,17.595,4.495,21.829,17.736c2.021,1.477,4.181,2.639,6.492,3.572c0.262,2.256,0.058,0.521,0.297,2.844
			c0.1-0.161,0.43,0.016,0.359-0.203l-0.406-3.375c-1.483-10.006-4.877-18.757-9.476-26.949c-1.321-0.77-2.322-2.119-2.446-4.051
			c-0.728-11.317,0.786-22.701-0.18-33.993c-0.797-9.316-2.946-18.448-3.759-27.748c-0.33-0.669-0.667-1.335-1.013-1.997
			c-1.57-2.999-3.928-6.961-7.745-5.446c-0.169,0.064-0.343,0.152-0.516,0.242c-1.335,0.147-2.64,0.807-3.605,2.168
			c-4.129,5.821-10.185,10.043-15.468,14.738c-4.961,4.409-8.661,10.149-13.906,14.247c-3.731-1.573-7.55-2.94-11.427-4.107
			c-8.831-2.578-12.828-3.536-15.88-4.114c1.982-4.62,3.585-10.161-0.385-13.248c-5.846-4.543-13.111,0.56-18.9,5.722
			c-1.219-1.556-3.372-2.428-5.296-1.786c-3.081,1.029-5.434,2.686-8.009,4.615c-0.005,0.003-0.01,0.006-0.015,0.01
			c-0.092-0.629-0.194-1.257-0.326-1.883c-0.657-3.115-4.721-4.645-7.345-2.988c-3.75,2.367-6.52,5.246-8.602,9.17
			c-0.639,1.203-1.163,2.509-1.689,3.821c-2.504,0.695-8.313,2.933-13.874,5.077c-5.45-4.296-10.782-8.697-15.526-13.786
			c-4.872-5.226-8.189-11.663-13.25-16.75c-0.063-0.063-0.128-0.116-0.191-0.174c-0.049-0.066-0.099-0.14-0.148-0.203
			c-0.202-0.304-0.422-0.569-0.658-0.796c-1.438-1.599-2.877-2.322-4.416-1.72c-1.092,0.418-1.939,1.27-2.688,2.141
			c-0.116,0.149-0.222,0.304-0.335,0.456c-0.841,4.215-2.144,8.241-3.307,12.458c-1.617,5.865-2.146,11.698-2.848,17.716
			c-1.502,12.87-2.423,25.794-3.944,38.66c-0.083,0.704-0.286,1.325-0.571,1.874c-0.082,0.856-0.442,1.697-0.844,2.443
			c-8.217,15.298-8.962,26.783-9.876,33.688l0.079,8.321l0.322,4.051c0.28,1.332,0.342,2.703,0.55,4.048l0.432,3.171
			c0.55,1.208,0.696,2.541,1.056,3.809c16.435,63.709,102.873,91.387,163.492,53.57c33.362-20.795,38.603-47.199,40.903-52.74
			l0.633-3.08c0.396-2.136,0.761-4.278,1.152-6.414l0.554-3.127l0.066-8.021C233.115,131.536,233.087,135.6,233.1,131.852z
			 M117.667,164.917c7.213,0.084,14.323,1.344,21.52,0.309c5.044-0.725,7.217,6.982,2.127,7.715
			c-2.604,0.374-5.169,0.499-7.723,0.511c-0.131,0.391-0.312,0.767-0.565,1.104c0.005,0.18,0.014,0.36,0.035,0.542
			c-0.019-0.141-0.038-0.282-0.057-0.423c0.097,0.911,0.037,1.734-0.466,2.594c-0.524,0.895-1.391,1.563-2.391,1.839
			c-1.032,0.283-2.159,0.138-3.083-0.403c-0.807-0.473-1.691-1.423-1.838-2.391c-0.169-1.117-0.242-2.06-0.1-3.117
			c-2.465-0.124-4.943-0.25-7.46-0.279C112.512,172.857,112.506,164.857,117.667,164.917z M163.523,204.325
			c-0.256,0.516-0.539,1.031-0.841,1.542c-4.345,11.585-17.755,19.956-29.421,20.998c-8.372,0.747-16.995,0.665-24.158-4.266
			c-0.123-0.084-0.24-0.175-0.361-0.261c-2.222-0.977-4.33-2.077-6.167-2.983c-3.656-1.802-9.117-4.756-11.481-8.691
			c-0.749-0.585-1.441-1.283-2.048-2.146c-1.304-1.851-1.633-3.631-1.272-5.19c-0.001-0.005-0.004-0.01-0.006-0.015
			c-0.362-1.317,0.075-2.925,1.056-3.948c0.022-0.143,0.028-0.279,0.069-0.429c0.189-0.688,0.583-1.309,1.099-1.802
			c0.109-0.178,0.216-0.357,0.336-0.533c0.958-1.4,2.075-2.602,3.325-3.662c0.952-1.09,1.975-2.108,3.025-3.029
			c2.813-2.466,6.049-4.994,9.726-5.988c0.304-0.128,0.646-0.225,1.032-0.279c6.686-0.953,13.396-1.424,20.137-1.772
			c5.067-0.262,10.659-1.092,15.626,0.416c0.016,0.005,0.03,0.011,0.046,0.016c0.415-0.032,0.85-0.021,1.318,0.091
			c6.698,1.59,17.534,4.754,20.686,11.506C167.282,198.254,166.016,201.54,163.523,204.325z"
            />
            <path
              d="M111.865,117.606c12.801,9.436,2.309,46.31-32.312,48.476l-0.02-0.035c-1.632,0.234-24.482,3.849-35.641-10.039
			c-8.113-9.902-10.449-18.361-7.23-28.757c4.317-12.492,7.789-12.953,13.335-14.179C56.967,111.742,94.713,109.699,111.865,117.606
			z"
            />
            <path
              d="M208.502,113.082c3.87,0.854,6.91,1.362,9.834,6.284c5.527,9.403,5.507,18.065,3.813,28.935
			c-0.092,0.203-0.088,0.428-0.123,0.645c-0.735,1.443-2.056,9.27-20.49,16.186c-8.381,3.053-19.702,1.617-26.349,0.535
			c-20.896-3.396-32.604-12.238-33.872-32.355c-0.494-5.526,0.748-12.289,5.253-15.696c4.949-2.297,10.311-3.554,15.692-4.319
			C172.903,111.755,198.287,111.103,208.502,113.082z"
            />
          </g>
        </g>
      </svg>
      <h4>Register and make your cat a star !</h4>
      <div class="field-aera">
        <input
          v-model="u_nickname"
          type="text"
          placeholder="Nickname"
          @change="checkSpace"
        />
        <span v-if="errorNickname" class="error-tab">{{ errorNickname }}</span>
      </div>
      <div class="field-aera">
        <input
          id="email"
          v-model="u_mail"
          type="text"
          placeholder="E-mail"
          autocomplete="email"
        />
        <span v-if="errorEmail" class="error-tab">{{ errorEmail }}</span>
      </div>
      <div class="field-aera">
        <input v-model="u_password" type="password" placeholder="Password" />
        <span v-if="errorPassword" class="error-tab">{{ errorPassword }}</span>
      </div>
      <div class="field-aera">
        <input
          v-model="u_password2"
          type="password"
          placeholder="Confirm your password"
        />
        <span v-if="errorPassword2" class="error-tab">{{
          errorPassword2
        }}</span>
      </div>
      <div class="field-aera flex">
        <label>Import your cat :</label>

        <base-image-input @img_selected="updateUserPicture" />
      </div>
      <div class="field-aera flex">
        <div data-test="login-btn" class="login-btn" @click="signUp_validation">
          Sign-up !
        </div>
        <router-link to="/home">
          <div data-test="login-btn" class="login-btn">
            Back
          </div>
        </router-link>
      </div>
    </div>
  </div>
</template>

<script>
import firebase from 'firebase/app'
import downscale from 'downscale'
import { mapActions } from 'vuex'
import BaseImageInput from '../components/internComponents/BaseImageInput.vue'

export default {
  components: {
    BaseImageInput
  },
  data() {
    return {
      v_spanner: true,

      u_nickname: '',
      u_mail: '',
      u_password: '',
      u_password2: '',
      u_picture: null,
      u_pictureUrl: null,

      reg: /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,24}))$/,

      errorNickname: '',
      errorEmail: '',
      errorPassword: '',
      errorPassword2: '',
      errorMessage: ''
    }
  },
  methods: {
    ...mapActions('authentication', [
      'updateUserDetails',
      'updateUserPictureLink'
    ]),
    checkSpace() {
      this.u_nickname = this.u_nickname.split(' ').join('')
    },
    signUp_validation() {
      // Function to validate Sign-Up form fields

      // Nickname verification
      if (this.u_nickname === null || this.u_nickname === '') {
        this.errorNickname = 'Please Enter a nickname'
      } else {
        this.errorNickname = ''
      }
      // Email verification
      if (this.u_mail === null || this.u_mail === '') {
        this.errorEmail = 'Please Enter Email'
      } else if (!this.reg.test(this.u_mail)) {
        this.errorEmail = 'Please Enter Correct Email'
      } else if (this.reg.test(this.u_mail)) {
        this.errorEmail = ''
      }
      // Password 1 verification
      if (this.u_password.length < 5 || this.u_password === '') {
        this.errorPassword = 'Minimum of 5 letters'
      } else {
        this.errorPassword = ''
      }
      // Password 2 verification
      if (
        this.u_password !== this.u_password2 ||
        this.u_password2 === null ||
        this.u_password2 === ''
      ) {
        this.errorPassword2 = 'Passwords are not corresonding'
      } else {
        this.errorPassword2 = ''
      }

      if (
        this.errorNickname === '' &&
        this.errorEmail === '' &&
        this.errorPassword === '' &&
        this.errorPassword2 === ''
      ) {
        this.signUp()
      }
    },

    async signUp() {
      firebase
        .auth()
        .createUserWithEmailAndPassword(this.u_mail, this.u_password)
        .then(response => {
          if (response) {
            const file = this.u_picture

            if (file) {
              firebase
                .storage()
                .ref(`avatars/${response.user.id}`)
                .putString(file, 'data_url') // Saving picture
              firebase
                .firestore()
                .doc(`/users/${response.user.id}`)
                .update({
                  hasAvatar: true
                })
            } else {
              firebase.auth().currentUser.updateProfile({
                photoURL: false
              })
            }

            // .then(() => {
            //   firebase
            //     .storage()
            //     .ref(`avatars/${firebase.auth().currentUser.uid}_600x600`)

            //     .getDownloadURL()
            //     .then(downURL => {
            //       console.log(downURL)
            //       firebase
            //         .auth()
            //         .currentUser.updateProfile({
            //           photoURL: downURL
            //         })
            //         .then(() => {
            //           this.updateUserPictureLink(
            //             firebase.auth().currentUser.uid
            //           )
            //         })
            //     })
            // })
            // } else {
            //   firebase
            //     .storage()
            //     .ref('avatars/nopicture.png')
            //     .getDownloadURL()
            //     .then(downURL => {
            //       firebase
            //         .auth()
            //         .currentUser.updateProfile({
            //           photoURL: downURL
            //         })
            //         .then(() => {
            //           this.updateUserPictureLink(
            //             firebase.auth().currentUser.uid
            //           )
            //         })
            //     })

            firebase
              .auth()
              .currentUser.updateProfile({
                displayName: this.u_nickname
              })
              .then(() => {
                this.updateUserDetails(firebase.auth().currentUser.uid)
              })
          }
        })
        .catch(error => {
          // Handle Errors here.
          const errorCode = error.code
          const errorMessage = error.message
          console.log(`${errorCode} - ${errorMessage}`)
          this.errorEmail = errorMessage

          // ...
        })
        .then(() => {
          this.sendEmail()
        })
      // todo
    },

    sendEmail() {
      firebase
        .auth()
        .currentUser.sendEmailVerification()
        .then(
          () => {
            // Email sent.
          },
          error => {
            console.log(error)
            // An error happened.
          }
        )
        .then(() => {
          this.$router.push({ name: 'home' })
        })
    },
    resetData() {
      this.u_nickname = ''
      this.u_mail = ''
      this.u_password = ''
      this.u_password2 = ''
      this.errorNickname = ''
      this.errorEmail = ''
      this.errorPassword = ''
      this.errorPassword2 = ''
    },
    updateUserPicture(value) {
      this.u_picture = value
      downscale(value, 200, 200, { quality: 1 }).then(dataV => {
        this.u_picture = dataV
      })
    }
  }
}
</script>

<style lang="scss" scoped>
@import '@/theme/variables.scss';

.component-wrapper {
  display: flex;
  flex-direction: column;
  max-width: 600px;
  width: 100%;
  align-items: center;
  padding: 15px 0px;
  //border: 1px solid;
  border-radius: 3px;
  background-color: rgba(255, 255, 255, 0.9);
  -webkit-box-shadow: 0px 0px 45px -7px rgba(0, 0, 0, 1);
  -moz-box-shadow: 0px 0px 45px -7px rgba(0, 0, 0, 1);
  box-shadow: 0px 0px 45px -7px rgba(0, 0, 0, 1);
  margin: 10px 10px;

  .image-top {
    width: 40%;
    margin: 0px 0px 0px 0px;
    fill: $blue-3;
    @media screen and (min-width: 600px) {
      //  margin: 0px 50px 20px 50px;
    }
  }

  .field-aera {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 5px;
  }

  .flex {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  input {
    width: 75%;
    padding: 10px;
    border-radius: 3px;
    border: 1px solid;
    -webkit-box-shadow: inset 0px 0px 9px -10px rgba(0, 0, 0, 0.75);
    -moz-box-shadow: inset 0px 0px 9px -10px rgba(0, 0, 0, 0.75);
    box-shadow: inset 0px 0px 9px -10px rgba(0, 0, 0, 0.75);

    // @media only screen and (max-width: 768px) {
    //   width: 70%;
    // }
  }
  .login-btn {
    margin: 5px;
    cursor: pointer;
    padding: 5px 20px;
    border: 1px solid;
    display: inline-block;
    border-radius: 3px;
    border-color: $border-color;

    &:hover {
      color: $hover;
      border-color: $hover;
    }
  }
}
</style>
